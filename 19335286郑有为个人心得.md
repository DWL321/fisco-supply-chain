<center><h1>实验心得体会</h1></center>

<center>郑有为 19335286</center>

​		通过本次实验，我们学习了区块链编程语言 Solidity 和开源区块链系统 FISCO-BCOS 的基本使用，进一步地掌握了区块链的知识点。FISCO 是联盟链，而比特币、以太坊是公有链，二者在节点的结构上存在相同点与不同点，除此之外，FISCO的共识机制与比特币、以太坊的共识机制不同，后者采用的是PoW。在应用的设计中，我们学习了 Node.js 和 Vue 并基于此搭建了前后端。

​		在实验中，我主要负责智能合约的编写，前期报告的编写和实验报告的编写和整理。过程中也遇到了许多问题，因为智能合约是最先写好的，但没有对接口等细节达成共识，导致前端的功能和调用与智能合约提供的功能不完全匹配，甚至出现了报错。再加上后端代码接口接收的参数不能处理枚举类型，也不能处理require语句返回的结果，导致合约代码一直在修改。

​		到最后的测试时，我们还发现智能合约代码仍有一些小问题，比如历史合约查询不能查到被转移的账单，虽然账单已经被转移了，但记录应该仍然存在。

​		最后我的修改方案是将 Receipt 结构体的`isSettled`（账单状态改为整形），有已结算、待结算和已转让三个状态。修改所有与账单状态有关的判断语句，并修改功能二转让账款的函数` transferReceipt`，代码改动很大。但由于时间问题，没有部署和测试。

```solidity
function transferReceipt(address to, int amount) public returns(bool) {
    Company storage company = companyMap[msg.sender];
    Company storage companyTo = companyMap[to];
    // require(company.isRegistered == true && companyTo.isRegistered == true, "[transferReceipt]: Company is not registered");
    if(!company.isRegistered || !companyTo.isRegistered) {
        return false;
    }

    if(getPendingReceiptsAmount() < amount) {
        return false;
    }

    int restAmount = amount;
    for(uint i = 0; i < receiptList.length; i++) {
        if(receiptList[i].to == msg.sender && !receiptList[i].isSettled) { // 直接转移账单接收方
            if(receiptList[i].amount <= restAmount) {
                
                // 修改原账单状态
                // receiptList[i].to = to;
                receiptList[i].isSettled = 2; // 已转让
                restAmount -= receiptList[i].amount;
                
                // 新建转账交易而不是直接转移
                receiptList.push(
                    Receipt({
                        from: receiptList[i].from,
                        to: to,
                        amount: receiptList[i].amount,
                        isSettled: 0 // 未解决
                    })
                );

                if(restAmount == 0) {
                    break;
                }
            }
            else { // 拆分一个账单的金额
            	
				// 拆分成 3 个账单
				// 1. 转移账单 to = 自己 isSettled = 2(已转移) 金额为新建账单的金额
				// 2. 剩余金额账单(原账单) isSettled = 0(未解决) 金额为剩余金额
				// 3. 新建账单 to = to isSettled = 0(未解决) 金额为新建账单的金额
				
				// 修改原账单
            	receiptList[i].amount -= restAmount;
				
				 // 新建转账交易（转移状态）
                receiptList.push(
                    Receipt({
                        from: msg.sender,
                        to: receiptList[i].to,
                        amount: restAmount,
                        isSettled: 2 // 已转让
                    })
                );
                
				// 新建转账交易
                receiptList.push(
                    Receipt({
                        from: receiptList[i].from,
                        to: to,
                        amount: restAmount,
                        isSettled: 0 // 未解决
                    })
                );
                break;
            }
        }
    }
    return true;
}
```

